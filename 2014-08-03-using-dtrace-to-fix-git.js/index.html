<!DOCTYPE html><html><head><link rel="preload" href="/_next/89335342-56c5-43a0-8822-3f5461cf1b74/page/2014-08-03-using-dtrace-to-fix-git.js/index.js" as="script"/><link rel="preload" href="/_next/89335342-56c5-43a0-8822-3f5461cf1b74/page/_error/index.js" as="script"/><link rel="preload" href="/_next/9c4da48c0e8fe8799db6472cb55898ca/app.js" as="script"/><meta charset="utf-8" class="next-head"/><title class="next-head">Using dtrace to fix git</title><meta name="viewport" content="initial-scale=1.0, width=device-width" class="next-head"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" class="next-head"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" class="next-head"/><link rel="stylesheet" href="/static/css/syntax.css" class="next-head"/><link rel="stylesheet" href="/static/css/gist.css" class="next-head"/><link rel="stylesheet" href="/static/css/main.css" class="next-head"/></head><body><div><div id="__next"><div data-reactroot="" data-reactid="1" data-react-checksum="1188786220"><div data-reactid="2"><div data-reactid="3"><!-- react-empty: 4 --><div class="navbar navbar-inverse navbar-fixed-top" role="navigation" data-reactid="5"><div class="container" data-reactid="6"><div class="navbar-header" data-reactid="7"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse" data-reactid="8"><span class="sr-only" data-reactid="9">Toggle navigation</span><span class="icon-bar" data-reactid="10"></span><span class="icon-bar" data-reactid="11"></span></button><a href="/" class="navbar-brand" data-reactid="12">Thoughts on Tech</a></div><div class="collapse navbar-collapse" data-reactid="13"><ul class="nav navbar-nav" data-reactid="14"><li data-reactid="15"><a href="/" data-reactid="16">Home</a></li><li data-reactid="17"><a href="/about" data-reactid="18">About</a></li></ul></div></div></div></div><div class="container" data-reactid="19"><div class="row" data-reactid="20"><div class="blog-main" data-reactid="21"><h2 class="blog-post-title" data-reactid="22">Using dtrace to fix git</h2><div data-reactid="23"><p class="blog-post-meta" data-reactid="24"><span class="glyphicon glyphicon-calendar" data-reactid="25"></span><!-- react-text: 26 --> <!-- /react-text --><!-- react-text: 27 -->03 Aug 2014<!-- /react-text --><!-- react-text: 28 --> <!-- /react-text --><a href="https://twitter.com/share" class="twitter-share-button" data-via="socketwiz" data-reactid="29">Tweet</a></p></div><p data-reactid="30"><!-- react-text: 31 -->First off the problem.  I like to develop on <!-- /react-text --><a href="http://smartos.org/" data-reactid="32">smartos</a><!-- react-text: 33 --> because it is based on Solaris and has all of the conveniences of Linux with a few extras namely zfs, zones and dtrace.  It’s dtrace that I’m going to discuss today.  I run a very specialized version of vim.  By specialized I mean I have a bunch of <!-- /react-text --><a href="https://github.com/socketwiz/dotfiles/tree/master/.vim/bundle" data-reactid="34">addons</a><!-- react-text: 35 -->.  In particular, <!-- /react-text --><a href="https://github.com/Valloric/YouCompleteMe" data-reactid="36">YouCompleteMe</a><!-- react-text: 37 --> and <!-- /react-text --><a href="https://github.com/SirVer/ultisnips" data-reactid="38">UltiSnips</a><!-- react-text: 39 --> requires that vim be a particular version and have python support compiled in.  The vim for smartos unfortunately does not so I build my own.  This leads us to my problem.  I also use git and when I do commits I want it to use vim, specifically my custom vim, otherwise it throws an error on startup complaining about the lack of python support.<!-- /react-text --></p><div class="highlighter-rouge" data-reactid="40"><pre class="highlight" data-reactid="41"><code data-reactid="42">YouCompleteMe unavailable: requires Vim 7.3.584+
UltiSnips requires py &amp;gt;= 2.6 or any py3
Press ENTER or type command to continue</code></pre></div><p data-reactid="43">To fix this there are two options:</p><ol data-reactid="44"><li data-reactid="45">git config –global core.editor &quot;/path/to/vim&quot;</li><li data-reactid="46">set the GIT_EDITOR, VISUAL, or EDITOR environment variables.</li></ol><p data-reactid="47">I opted for the later because I share my $HOME/.gitconfig on 3 different systems, smartos, mac, and windows, and vim lives in different locations on each of them.  The environment variable would be the ideal solution but it seems to be ignored because I have EDITOR set already.  I tried setting GIT_EDITOR to no avail.  So what’s going on and more importantly how can I fix it?  One option might be to download the source code for git and try to debug it and figure out what the problem is, but that seems like a lot of work for such a small annoyance.  I chose to utilize dtrace, after all theres no since running on smartos if you’re not going to take advantage of its conveniences. My goal was to try and figure out where git was searching for vim in an attempt to try and figure out why it was not finding my vim, and instead using the system vim.  My path has my vim ahead of the system vim so in theory it should have found it.  Here is the command I came up with:</p><div class="highlighter-rouge" data-reactid="48"><pre class="highlight" data-reactid="49"><code data-reactid="50"><!-- react-text: 51 -->dtrace -n &#x27;syscall::exec*:entry /execname==&quot;git&quot;/ <!-- /react-text --><!-- react-text: 52 -->{<!-- /react-text --><!-- react-text: 53 --> printf(&quot;%s\n&quot;, copyinstr(arg0)); <!-- /react-text --><!-- react-text: 54 -->}<!-- /react-text --><!-- react-text: 55 -->&#x27;<!-- /react-text --></code></pre></div><p data-reactid="56">I fired up tmux because I run smartos remotely and I wanted to take advantage of the multiple windows so I didn’t have to make 2 ssh connections.  In the first window I ran sudo -i because dtrace wants to run as root, then I ran the command above.  In the second window I ran “git commit” and here is what dtrace output:</p><div class="highlighter-rouge" data-reactid="57"><pre class="highlight" data-reactid="58"><code data-reactid="59">dtrace: description &#x27;syscall::exec*:entry &#x27; matched 1 probe
CPU     ID                    FUNCTION:NAME
3   7129                      exece:entry /opt/local/libexec/git-core/vi

3   7129                      exece:entry /opt/local/bin/vi

3   7129                      exece:entry /opt/local/bin/vi

3   7129                      exece:entry /usr/local/sbin/vi

3   7129                      exece:entry /usr/local/bin/vi

3   7129                      exece:entry /opt/local/sbin/vi

3   7129                      exece:entry /opt/local/bin/vi

3   7129                      exece:entry /usr/sbin/vi

3   7129                      exece:entry /usr/bin/vi</code></pre></div><p data-reactid="60">Aha! I don’t understand why, but for some reason it’s not looking for vim at all, it’s looking for vi.  I could fix this in one of two ways.  Download the source for git and try and figure out why it’s doing this, or simply make a symbolic link from vi to my vim and call it a day.  I chose the latter:</p><div class="highlighter-rouge" data-reactid="61"><pre class="highlight" data-reactid="62"><code data-reactid="63">sudo ln -s /opt/local/bin/vim /opt/local/bin/vi</code></pre></div><p data-reactid="64">Now when I run “git commit” I get:</p><div class="highlighter-rouge" data-reactid="65"><pre class="highlight" data-reactid="66"><code data-reactid="67">dtrace: description &#x27;syscall::exec*:entry &#x27; matched 1 probe
CPU     ID                    FUNCTION:NAME
1   7129                      exece:entry /opt/local/libexec/git-core/vi

1   7129                      exece:entry /opt/local/bin/vi</code></pre></div><p data-reactid="68">As well as the proper vim that I’m expecting.</p><div data-reactid="69"><div id="disqus_thread" data-reactid="70"></div></div></div></div></div><div class="blog-footer" data-reactid="71"><p data-reactid="72"><a href="http://www.linkedin.com/in/socketwiz/" data-reactid="73"><i class="fa fa-linkedin social" data-reactid="74"></i></a><!-- react-text: 75 --> <!-- /react-text --><a href="https://github.com/socketwiz" data-reactid="76"><i class="fa fa-github social" data-reactid="77"></i></a><!-- react-text: 78 --> <!-- /react-text --><a href="https://twitter.com/socketwiz" data-reactid="79"><i class="fa fa-twitter social" data-reactid="80"></i></a></p></div></div></div></div><div id="__next-error"></div></div><div><script>
          __NEXT_DATA__ = {"props":{},"pathname":"/2014-08-03-using-dtrace-to-fix-git.js","query":{},"buildId":"89335342-56c5-43a0-8822-3f5461cf1b74","buildStats":{"app.js":{"hash":"9c4da48c0e8fe8799db6472cb55898ca"}},"assetPrefix":"","nextExport":true,"err":null,"chunks":[]}
          module={}
          __NEXT_LOADED_PAGES__ = []
          __NEXT_LOADED_CHUNKS__ = []

          __NEXT_REGISTER_PAGE = function (route, fn) {
            __NEXT_LOADED_PAGES__.push({ route: route, fn: fn })
          }

          __NEXT_REGISTER_CHUNK = function (chunkName, fn) {
            __NEXT_LOADED_CHUNKS__.push({ chunkName: chunkName, fn: fn })
          }
        </script><script async="" id="__NEXT_PAGE__/2014-08-03-using-dtrace-to-fix-git.js" type="text/javascript" src="/_next/89335342-56c5-43a0-8822-3f5461cf1b74/page/2014-08-03-using-dtrace-to-fix-git.js/index.js"></script><script async="" id="__NEXT_PAGE__/_error" type="text/javascript" src="/_next/89335342-56c5-43a0-8822-3f5461cf1b74/page/_error/index.js"></script><div></div><script type="text/javascript" src="/_next/9c4da48c0e8fe8799db6472cb55898ca/app.js" async=""></script></div></body></html>